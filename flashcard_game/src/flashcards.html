<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Constellation Flashcard Game</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      background: #0a0a0f;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 40px 20px;
    }

    h1 {
      color: rgba(255,255,255,0.9);
      font-size: 1.8rem;
      font-weight: 500;
      margin-bottom: 8px;
      letter-spacing: 0.02em;
    }

    .subtitle {
      color: rgba(255,255,255,0.5);
      font-size: 0.95rem;
      margin-bottom: 32px;
    }

    #game-container {
      position: relative;
      width: 600px;
      max-width: 95vw;
    }

    canvas {
      display: block;
      border-radius: 12px;
    }

    #input-area {
      display: none;
      margin-top: 28px;
      text-align: center;
    }

    #guess-input {
      width: 320px;
      max-width: 70%;
      padding: 14px 20px;
      font-size: 1rem;
      border: 1px solid rgba(255,255,255,0.15);
      border-radius: 8px;
      background: rgba(255,255,255,0.05);
      color: rgba(255,255,255,0.9);
      outline: none;
      transition: border-color 0.2s, background 0.2s;
    }

    #guess-input:focus {
      border-color: rgba(255,255,255,0.3);
      background: rgba(255,255,255,0.08);
    }

    #guess-input::placeholder {
      color: rgba(255,255,255,0.35);
    }

    #submit-btn {
      margin-left: 12px;
      padding: 14px 28px;
      font-size: 1rem;
      font-weight: 500;
      border: none;
      border-radius: 8px;
      background: rgba(255,255,255,0.9);
      color: #0a0a0f;
      cursor: pointer;
      transition: background 0.2s, transform 0.15s;
    }

    #submit-btn:hover {
      background: rgba(255,255,255,1);
      transform: translateY(-1px);
    }

    #submit-btn:active {
      transform: translateY(0);
    }

    .btn-generic {
      display: none;
      margin-top: 28px;
      padding: 14px 36px;
      font-size: 1rem;
      font-weight: 500;
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 8px;
      background: transparent;
      color: rgba(255,255,255,0.8);
      cursor: pointer;
      transition: background 0.2s, border-color 0.2s, transform 0.15s;
    }

    .btn-generic:hover {
      background: rgba(255,255,255,0.05);
      border-color: rgba(255,255,255,0.3);
      transform: translateY(-1px);
    }

    #progress-bar {
      width: 100%;
      height: 2px;
      background: rgba(255,255,255,0.1);
      border-radius: 1px;
      margin-bottom: 24px;
      overflow: hidden;
    }

    #progress-fill {
      height: 100%;
      background: rgba(255,255,255,0.5);
      border-radius: 1px;
      transition: width 0.4s ease;
      width: 0%;
    }

    #score-display {
      color: rgba(255,255,255,0.6);
      font-size: 0.9rem;
      font-weight: 400;
      margin-bottom: 16px;
      letter-spacing: 0.03em;
    }
  </style>
</head>
<body>
  <h1>Constellation Challenge</h1>
  <p class="subtitle">Can you name the constellations? &mdash; 10 star maps, how many can you identify?</p>

  <div id="score-display">Score: 0 / 0</div>
  <div id="game-container">
    <div id="progress-bar"><div id="progress-fill"></div></div>
    <canvas id="gameCanvas" width="600" height="420"></canvas>
    <div id="input-area">
      <input type="text" id="guess-input" placeholder="Type your answer..." autocomplete="off">
      <button id="submit-btn">Submit</button>
    </div>
    <button id="next-btn" class="btn-generic">Next Card</button>
    <button id="start-btn" class="btn-generic" style="display:inline-block;background:rgba(255,255,255,0.9);color:#0a0a0f;border:none;">Start Game</button>
    <button id="restart-btn" class="btn-generic">Play Again</button>
  </div>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const inputArea = document.getElementById('input-area');
const guessInput = document.getElementById('guess-input');
const submitBtn = document.getElementById('submit-btn');
const nextBtn = document.getElementById('next-btn');
const startBtn = document.getElementById('start-btn');
const restartBtn = document.getElementById('restart-btn');
const scoreDisplay = document.getElementById('score-display');
const progressFill = document.getElementById('progress-fill');

let allCards = [];
let gameCards = [];
let currentIndex = 0;
let score = 0;
let answered = 0;
let state = 'loading'; // loading, ready, showing, answered, finished
let loadedImage = null;
let particles = [];
let animFrame = null;

// --- Utility ---
function shuffle(arr) {
  const a = arr.slice();
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

function normalize(str) {
  return str.trim().toLowerCase().replace(/[^a-z0-9]/g, '');
}

// --- Canvas Drawing Helpers ---
function clearCanvas() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
}

function drawRoundRect(x, y, w, h, r, fill, stroke) {
  ctx.beginPath();
  ctx.moveTo(x + r, y);
  ctx.lineTo(x + w - r, y);
  ctx.quadraticCurveTo(x + w, y, x + w, y + r);
  ctx.lineTo(x + w, y + h - r);
  ctx.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
  ctx.lineTo(x + r, y + h);
  ctx.quadraticCurveTo(x, y + h, x, y + h - r);
  ctx.lineTo(x, y + r);
  ctx.quadraticCurveTo(x, y, x + r, y);
  ctx.closePath();
  if (fill) { ctx.fillStyle = fill; ctx.fill(); }
  if (stroke) { ctx.strokeStyle = stroke; ctx.lineWidth = 2; ctx.stroke(); }
}

function drawCardBackground() {
  // Dark background matching image backgrounds
  ctx.fillStyle = '#0a0a0f';
  ctx.fillRect(0, 0, canvas.width, canvas.height);

  // Subtle border
  ctx.strokeStyle = 'rgba(255,255,255,0.08)';
  ctx.lineWidth = 1;
  drawRoundRect(0, 0, canvas.width, canvas.height, 12, null, 'rgba(255,255,255,0.08)');
}

function drawWrappedText(text, x, y, maxWidth, lineHeight, font, color) {
  ctx.font = font;
  ctx.fillStyle = color;
  ctx.textAlign = 'center';
  const words = text.split(' ');
  let line = '';
  let currentY = y;
  for (const word of words) {
    const testLine = line + (line ? ' ' : '') + word;
    if (ctx.measureText(testLine).width > maxWidth && line) {
      ctx.fillText(line, x, currentY);
      line = word;
      currentY += lineHeight;
    } else {
      line = testLine;
    }
  }
  ctx.fillText(line, x, currentY);
  return currentY;
}

function drawCardNumber() {
  ctx.save();
  ctx.font = '13px system-ui, sans-serif';
  ctx.fillStyle = 'rgba(255,255,255,0.4)';
  ctx.textAlign = 'right';
  ctx.fillText(`${currentIndex + 1} / ${gameCards.length}`, 575, 25);
  ctx.restore();
}

// --- Particle system for correct answers ---
function spawnParticles(cx, cy) {
  for (let i = 0; i < 20; i++) {
    const angle = Math.random() * Math.PI * 2;
    const speed = 1.5 + Math.random() * 3;
    particles.push({
      x: cx, y: cy,
      vx: Math.cos(angle) * speed,
      vy: Math.sin(angle) * speed - 1.5,
      life: 1,
      decay: 0.02 + Math.random() * 0.02,
      size: 2 + Math.random() * 3,
      color: ['rgba(255,255,255,0.8)','rgba(255,255,255,0.6)','rgba(200,200,220,0.7)'][Math.floor(Math.random()*3)]
    });
  }
}

function updateParticles() {
  for (let i = particles.length - 1; i >= 0; i--) {
    const p = particles[i];
    p.x += p.vx;
    p.y += p.vy;
    p.vy += 0.1;
    p.life -= p.decay;
    if (p.life <= 0) particles.splice(i, 1);
  }
}

function drawParticles() {
  for (const p of particles) {
    ctx.save();
    ctx.globalAlpha = p.life;
    ctx.fillStyle = p.color;
    ctx.beginPath();
    ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
    ctx.fill();
    ctx.restore();
  }
}

// --- Screens ---
function drawWelcomeScreen() {
  clearCanvas();
  // Dark background
  ctx.fillStyle = '#0a0a0f';
  ctx.fillRect(0, 0, canvas.width, canvas.height);

  // Subtle star dots
  ctx.save();
  for (let i = 0; i < 40; i++) {
    const x = Math.random() * canvas.width;
    const y = Math.random() * canvas.height;
    const size = Math.random() * 1.5 + 0.5;
    ctx.fillStyle = `rgba(255,255,255,${Math.random() * 0.3 + 0.1})`;
    ctx.beginPath();
    ctx.arc(x, y, size, 0, Math.PI * 2);
    ctx.fill();
  }
  ctx.restore();

  // Title
  ctx.font = '500 28px system-ui, sans-serif';
  ctx.fillStyle = 'rgba(255,255,255,0.9)';
  ctx.textAlign = 'center';
  ctx.fillText('Constellation Challenge', canvas.width / 2, 140);

  // Subtitle
  ctx.font = '16px system-ui, sans-serif';
  ctx.fillStyle = 'rgba(255,255,255,0.4)';
  ctx.fillText('10 star maps to identify', canvas.width / 2, 180);

  // Decorative constellation dots
  ctx.save();
  const dots = [
    {x: 240, y: 260}, {x: 280, y: 240}, {x: 320, y: 255},
    {x: 360, y: 235}, {x: 340, y: 280}
  ];
  ctx.strokeStyle = 'rgba(255,255,255,0.15)';
  ctx.lineWidth = 1;
  ctx.beginPath();
  ctx.moveTo(dots[0].x, dots[0].y);
  for (let i = 1; i < dots.length; i++) {
    ctx.lineTo(dots[i].x, dots[i].y);
  }
  ctx.stroke();
  for (const dot of dots) {
    ctx.fillStyle = 'rgba(255,255,255,0.6)';
    ctx.beginPath();
    ctx.arc(dot.x, dot.y, 3, 0, Math.PI * 2);
    ctx.fill();
  }
  ctx.restore();

  ctx.font = '14px system-ui, sans-serif';
  ctx.fillStyle = 'rgba(255,255,255,0.3)';
  ctx.textAlign = 'center';
  ctx.fillText(`${allCards.length} cards loaded`, canvas.width / 2, 380);
}

function drawQuestionCard(card) {
  clearCanvas();
  drawCardBackground();
  drawCardNumber();

  if (card.type === 'image' && loadedImage) {
    // Draw the image centered - sized to fill more of the canvas
    const maxW = 500;
    const maxH = 340;
    let w = loadedImage.width;
    let h = loadedImage.height;
    const scale = Math.min(maxW / w, maxH / h, 1);
    w *= scale;
    h *= scale;
    const ix = (canvas.width - w) / 2;
    const iy = 40 + (360 - h) / 2;
    ctx.drawImage(loadedImage, ix, iy, w, h);
  } else {
    // Draw text question
    ctx.font = '500 20px system-ui, sans-serif';
    ctx.fillStyle = 'rgba(255,255,255,0.3)';
    ctx.textAlign = 'center';
    ctx.fillText('?', canvas.width / 2, 100);

    drawWrappedText(
      card.input, canvas.width / 2, 200,
      480, 32, '20px system-ui, sans-serif', 'rgba(255,255,255,0.85)'
    );
  }

  // Hint
  ctx.font = '13px system-ui, sans-serif';
  ctx.fillStyle = 'rgba(255,255,255,0.25)';
  ctx.textAlign = 'center';
  ctx.fillText('Type your answer below', canvas.width / 2, 400);
}

function drawAnswerReveal(card, userAnswer, isCorrect) {
  clearCanvas();
  drawCardBackground();
  drawCardNumber();

  // Result text
  const resultY = 80;
  const resultText = isCorrect ? 'Correct' : 'Incorrect';
  ctx.font = '500 18px system-ui, sans-serif';
  ctx.fillStyle = isCorrect ? 'rgba(134,239,172,0.9)' : 'rgba(248,113,113,0.8)';
  ctx.textAlign = 'center';
  ctx.fillText(resultText, canvas.width / 2, resultY);

  // Your answer
  ctx.font = '14px system-ui, sans-serif';
  ctx.fillStyle = 'rgba(255,255,255,0.4)';
  ctx.fillText('Your answer', canvas.width / 2, 140);

  ctx.font = '500 20px system-ui, sans-serif';
  ctx.fillStyle = isCorrect ? 'rgba(134,239,172,0.9)' : 'rgba(248,113,113,0.8)';
  ctx.fillText(userAnswer || '(no answer)', canvas.width / 2, 170);

  // Correct answer
  ctx.font = '14px system-ui, sans-serif';
  ctx.fillStyle = 'rgba(255,255,255,0.4)';
  ctx.fillText('Correct answer', canvas.width / 2, 230);

  ctx.font = '500 24px system-ui, sans-serif';
  ctx.fillStyle = 'rgba(255,255,255,0.9)';
  ctx.fillText(card.answer, canvas.width / 2, 265);

  // Divider
  ctx.beginPath();
  ctx.moveTo(180, 300);
  ctx.lineTo(420, 300);
  ctx.strokeStyle = 'rgba(255,255,255,0.1)';
  ctx.lineWidth = 1;
  ctx.stroke();

  // Running score
  ctx.font = '15px system-ui, sans-serif';
  ctx.fillStyle = 'rgba(255,255,255,0.5)';
  ctx.textAlign = 'center';
  ctx.fillText(`${score} of ${answered} correct`, canvas.width / 2, 340);

  // Progress dots
  const dotStartX = canvas.width / 2 - (gameCards.length * 16) / 2;
  for (let i = 0; i < gameCards.length; i++) {
    ctx.beginPath();
    ctx.arc(dotStartX + i * 16, 375, 4, 0, Math.PI * 2);
    if (i < answered) {
      ctx.fillStyle = gameCards[i]._correct ? 'rgba(134,239,172,0.8)' : 'rgba(248,113,113,0.6)';
      if (i === answered - 1) {
        ctx.fillStyle = isCorrect ? 'rgba(134,239,172,0.8)' : 'rgba(248,113,113,0.6)';
      }
    } else {
      ctx.fillStyle = 'rgba(255,255,255,0.15)';
    }
    ctx.fill();
  }

  // Particles for correct
  if (isCorrect) {
    spawnParticles(canvas.width / 2, resultY - 10);
  }
}

function drawFinalScreen() {
  clearCanvas();

  // Dark background
  ctx.fillStyle = '#0a0a0f';
  ctx.fillRect(0, 0, canvas.width, canvas.height);

  // Subtle stars
  ctx.save();
  for (let i = 0; i < 30; i++) {
    const x = Math.random() * canvas.width;
    const y = Math.random() * canvas.height;
    const size = Math.random() * 1.2 + 0.3;
    ctx.fillStyle = `rgba(255,255,255,${Math.random() * 0.2 + 0.1})`;
    ctx.beginPath();
    ctx.arc(x, y, size, 0, Math.PI * 2);
    ctx.fill();
  }
  ctx.restore();

  ctx.font = '500 24px system-ui, sans-serif';
  ctx.fillStyle = 'rgba(255,255,255,0.9)';
  ctx.textAlign = 'center';
  ctx.fillText('Complete', canvas.width / 2, 90);

  // Score display
  const cx = canvas.width / 2;
  const cy = 200;
  const r = 50;

  // Background circle
  ctx.beginPath();
  ctx.arc(cx, cy, r, 0, Math.PI * 2);
  ctx.strokeStyle = 'rgba(255,255,255,0.1)';
  ctx.lineWidth = 2;
  ctx.stroke();

  // Score arc
  const pct = score / gameCards.length;
  ctx.beginPath();
  ctx.arc(cx, cy, r, -Math.PI / 2, -Math.PI / 2 + Math.PI * 2 * pct);
  ctx.strokeStyle = 'rgba(255,255,255,0.6)';
  ctx.lineWidth = 3;
  ctx.stroke();

  // Score text
  ctx.font = '500 32px system-ui, sans-serif';
  ctx.fillStyle = 'rgba(255,255,255,0.9)';
  ctx.textAlign = 'center';
  ctx.fillText(`${score}`, cx, cy + 8);
  ctx.font = '14px system-ui, sans-serif';
  ctx.fillStyle = 'rgba(255,255,255,0.4)';
  ctx.fillText(`of ${gameCards.length}`, cx, cy + 30);

  // Message
  let msg = '';
  if (pct === 1) msg = 'Perfect';
  else if (pct >= 0.8) msg = 'Well done';
  else if (pct >= 0.5) msg = 'Good effort';
  else msg = 'Keep practicing';

  ctx.font = '16px system-ui, sans-serif';
  ctx.fillStyle = 'rgba(255,255,255,0.5)';
  ctx.fillText(msg, cx, 300);

  // Review dots
  const dotStartX = cx - (gameCards.length * 16) / 2;
  for (let i = 0; i < gameCards.length; i++) {
    ctx.beginPath();
    ctx.arc(dotStartX + i * 16, 350, 4, 0, Math.PI * 2);
    ctx.fillStyle = gameCards[i]._correct ? 'rgba(134,239,172,0.8)' : 'rgba(248,113,113,0.6)';
    ctx.fill();
  }

  // Spawn subtle celebration particles
  if (particles.length === 0 && score > 0) {
    spawnParticles(cx, cy - 30);
  }
}

// --- Animation loop ---
function animationLoop() {
  if (particles.length > 0) {
    updateParticles();
    // Redraw current screen then overlay particles
    if (state === 'answered') {
      const card = gameCards[currentIndex];
      drawAnswerReveal(card, card._userAnswer, card._correct);
      // Prevent re-spawning
    } else if (state === 'finished') {
      drawFinalScreen();
    }
    drawParticles();
  }
  animFrame = requestAnimationFrame(animationLoop);
}

// --- Game Flow ---
async function loadDatabase() {
  const resp = await fetch('flashcard-db.json');
  const data = await resp.json();
  allCards = data.cards;
}

function selectCards() {
  const shuffled = shuffle(allCards);
  gameCards = shuffled.slice(0, Math.min(10, shuffled.length));
  // Reset metadata
  gameCards.forEach(c => {
    c._correct = false;
    c._userAnswer = '';
  });
}

function loadCardImage(card) {
  return new Promise((resolve) => {
    if (card.type !== 'image') { loadedImage = null; resolve(); return; }
    const img = new Image();
    img.onload = () => { loadedImage = img; resolve(); };
    img.onerror = () => { loadedImage = null; resolve(); };
    img.src = card.input;
  });
}

async function showCard() {
  state = 'showing';
  const card = gameCards[currentIndex];
  await loadCardImage(card);
  drawQuestionCard(card);
  inputArea.style.display = 'block';
  nextBtn.style.display = 'none';
  guessInput.value = '';
  guessInput.focus();
  updateProgress();
}

function submitAnswer() {
  if (state !== 'showing') return;
  const card = gameCards[currentIndex];
  const userAnswer = guessInput.value;
  const isCorrect = normalize(userAnswer) === normalize(card.answer);

  card._userAnswer = userAnswer;
  card._correct = isCorrect;

  if (isCorrect) score++;
  answered++;

  state = 'answered';
  inputArea.style.display = 'none';
  particles = [];
  drawAnswerReveal(card, userAnswer, isCorrect);
  updateScoreDisplay();
  updateProgress();

  if (currentIndex < gameCards.length - 1) {
    nextBtn.style.display = 'inline-block';
  } else {
    // Last card - show finish button
    nextBtn.textContent = 'See Results';
    nextBtn.style.display = 'inline-block';
  }
}

function nextCard() {
  if (currentIndex < gameCards.length - 1) {
    currentIndex++;
    particles = [];
    showCard();
  } else {
    showFinalScreen();
  }
}

function showFinalScreen() {
  state = 'finished';
  inputArea.style.display = 'none';
  nextBtn.style.display = 'none';
  restartBtn.style.display = 'inline-block';
  particles = [];
  drawFinalScreen();
  updateProgress();
}

function updateScoreDisplay() {
  scoreDisplay.textContent = `Score: ${score} / ${answered}`;
}

function updateProgress() {
  const pct = (answered / gameCards.length) * 100;
  progressFill.style.width = pct + '%';
}

function resetGame() {
  currentIndex = 0;
  score = 0;
  answered = 0;
  particles = [];
  loadedImage = null;
  restartBtn.style.display = 'none';
  nextBtn.textContent = 'Next Card';
  updateScoreDisplay();
  selectCards();
  showCard();
}

// --- Event Listeners ---
submitBtn.addEventListener('click', submitAnswer);
guessInput.addEventListener('keydown', (e) => {
  if (e.key === 'Enter') submitAnswer();
});
nextBtn.addEventListener('click', nextCard);
startBtn.addEventListener('click', () => {
  startBtn.style.display = 'none';
  resetGame();
});
restartBtn.addEventListener('click', resetGame);

// --- Init ---
(async function init() {
  await loadDatabase();
  state = 'ready';
  drawWelcomeScreen();
  animationLoop();
})();
</script>
</body>
</html>
