<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Constellation Flashcard Game</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      background: linear-gradient(135deg, #0b1026 0%, #1a1040 50%, #0d0d2b 100%);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    h1 {
      color: #fff;
      font-size: 2.2rem;
      margin-bottom: 8px;
      text-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }

    .subtitle {
      color: rgba(255,255,255,0.8);
      font-size: 1rem;
      margin-bottom: 24px;
    }

    #game-container {
      position: relative;
      width: 600px;
      max-width: 95vw;
    }

    canvas {
      display: block;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }

    #input-area {
      display: none;
      margin-top: 20px;
      text-align: center;
    }

    #guess-input {
      width: 320px;
      max-width: 80%;
      padding: 14px 20px;
      font-size: 1.1rem;
      border: 3px solid rgba(255,255,255,0.3);
      border-radius: 12px;
      background: rgba(255,255,255,0.95);
      color: #333;
      outline: none;
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    #guess-input:focus {
      border-color: #667eea;
      box-shadow: 0 0 0 4px rgba(102,126,234,0.3);
    }

    #guess-input::placeholder {
      color: #aaa;
    }

    #submit-btn {
      margin-left: 10px;
      padding: 14px 28px;
      font-size: 1.1rem;
      font-weight: 600;
      border: none;
      border-radius: 12px;
      background: linear-gradient(135deg, #f093fb, #f5576c);
      color: #fff;
      cursor: pointer;
      transition: transform 0.15s, box-shadow 0.15s;
      box-shadow: 0 4px 15px rgba(245,87,108,0.4);
    }

    #submit-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(245,87,108,0.5);
    }

    #submit-btn:active {
      transform: translateY(0);
    }

    .btn-generic {
      display: none;
      margin-top: 20px;
      padding: 14px 36px;
      font-size: 1.1rem;
      font-weight: 600;
      border: none;
      border-radius: 12px;
      background: linear-gradient(135deg, #43e97b, #38f9d7);
      color: #1a1a2e;
      cursor: pointer;
      transition: transform 0.15s, box-shadow 0.15s;
      box-shadow: 0 4px 15px rgba(67,233,123,0.4);
    }

    .btn-generic:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(67,233,123,0.5);
    }

    #progress-bar {
      width: 100%;
      height: 6px;
      background: rgba(255,255,255,0.2);
      border-radius: 3px;
      margin-bottom: 16px;
      overflow: hidden;
    }

    #progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #43e97b, #38f9d7);
      border-radius: 3px;
      transition: width 0.4s ease;
      width: 0%;
    }

    #score-display {
      color: #fff;
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 12px;
      text-shadow: 0 1px 4px rgba(0,0,0,0.2);
    }
  </style>
</head>
<body>
  <h1>Constellation Challenge</h1>
  <p class="subtitle">Can you name the constellations? &mdash; 10 star maps, how many can you identify?</p>

  <div id="score-display">Score: 0 / 0</div>
  <div id="game-container">
    <div id="progress-bar"><div id="progress-fill"></div></div>
    <canvas id="gameCanvas" width="600" height="420"></canvas>
    <div id="input-area">
      <input type="text" id="guess-input" placeholder="Type your answer..." autocomplete="off">
      <button id="submit-btn">Submit</button>
    </div>
    <button id="next-btn" class="btn-generic">Next Card</button>
    <button id="start-btn" class="btn-generic" style="display:inline-block;">Start Game</button>
    <button id="restart-btn" class="btn-generic">Play Again</button>
  </div>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const inputArea = document.getElementById('input-area');
const guessInput = document.getElementById('guess-input');
const submitBtn = document.getElementById('submit-btn');
const nextBtn = document.getElementById('next-btn');
const startBtn = document.getElementById('start-btn');
const restartBtn = document.getElementById('restart-btn');
const scoreDisplay = document.getElementById('score-display');
const progressFill = document.getElementById('progress-fill');

let allCards = [];
let gameCards = [];
let currentIndex = 0;
let score = 0;
let answered = 0;
let state = 'loading'; // loading, ready, showing, answered, finished
let loadedImage = null;
let particles = [];
let animFrame = null;

// --- Utility ---
function shuffle(arr) {
  const a = arr.slice();
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

function normalize(str) {
  return str.trim().toLowerCase().replace(/[^a-z0-9]/g, '');
}

// --- Canvas Drawing Helpers ---
function clearCanvas() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
}

function drawRoundRect(x, y, w, h, r, fill, stroke) {
  ctx.beginPath();
  ctx.moveTo(x + r, y);
  ctx.lineTo(x + w - r, y);
  ctx.quadraticCurveTo(x + w, y, x + w, y + r);
  ctx.lineTo(x + w, y + h - r);
  ctx.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
  ctx.lineTo(x + r, y + h);
  ctx.quadraticCurveTo(x, y + h, x, y + h - r);
  ctx.lineTo(x, y + r);
  ctx.quadraticCurveTo(x, y, x + r, y);
  ctx.closePath();
  if (fill) { ctx.fillStyle = fill; ctx.fill(); }
  if (stroke) { ctx.strokeStyle = stroke; ctx.lineWidth = 2; ctx.stroke(); }
}

function drawCardBackground() {
  // Soft card background
  ctx.save();
  ctx.shadowColor = 'rgba(0,0,0,0.12)';
  ctx.shadowBlur = 20;
  ctx.shadowOffsetY = 8;
  drawRoundRect(40, 20, 520, 380, 20, '#ffffff', null);
  ctx.restore();

  // Decorative top accent
  ctx.save();
  ctx.beginPath();
  ctx.moveTo(60, 20);
  ctx.lineTo(540, 20);
  ctx.quadraticCurveTo(560, 20, 560, 40);
  ctx.lineTo(560, 28);
  ctx.lineTo(40, 28);
  ctx.lineTo(40, 40);
  ctx.quadraticCurveTo(40, 20, 60, 20);
  ctx.closePath();
  const accent = ctx.createLinearGradient(40, 20, 560, 20);
  accent.addColorStop(0, '#667eea');
  accent.addColorStop(1, '#764ba2');
  ctx.fillStyle = accent;
  ctx.fill();
  ctx.restore();
}

function drawWrappedText(text, x, y, maxWidth, lineHeight, font, color) {
  ctx.font = font;
  ctx.fillStyle = color;
  ctx.textAlign = 'center';
  const words = text.split(' ');
  let line = '';
  let currentY = y;
  for (const word of words) {
    const testLine = line + (line ? ' ' : '') + word;
    if (ctx.measureText(testLine).width > maxWidth && line) {
      ctx.fillText(line, x, currentY);
      line = word;
      currentY += lineHeight;
    } else {
      line = testLine;
    }
  }
  ctx.fillText(line, x, currentY);
  return currentY;
}

function drawCardNumber() {
  ctx.save();
  ctx.font = 'bold 14px system-ui, sans-serif';
  ctx.fillStyle = 'rgba(255,255,255,0.9)';
  ctx.textAlign = 'right';
  ctx.fillText(`${currentIndex + 1} / ${gameCards.length}`, 545, 17);
  ctx.restore();
}

// --- Particle system for correct answers ---
function spawnParticles(cx, cy) {
  for (let i = 0; i < 30; i++) {
    const angle = Math.random() * Math.PI * 2;
    const speed = 2 + Math.random() * 4;
    particles.push({
      x: cx, y: cy,
      vx: Math.cos(angle) * speed,
      vy: Math.sin(angle) * speed - 2,
      life: 1,
      decay: 0.015 + Math.random() * 0.02,
      size: 3 + Math.random() * 5,
      color: ['#f093fb','#43e97b','#667eea','#f5576c','#ffd700'][Math.floor(Math.random()*5)]
    });
  }
}

function updateParticles() {
  for (let i = particles.length - 1; i >= 0; i--) {
    const p = particles[i];
    p.x += p.vx;
    p.y += p.vy;
    p.vy += 0.1;
    p.life -= p.decay;
    if (p.life <= 0) particles.splice(i, 1);
  }
}

function drawParticles() {
  for (const p of particles) {
    ctx.save();
    ctx.globalAlpha = p.life;
    ctx.fillStyle = p.color;
    ctx.beginPath();
    ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
    ctx.fill();
    ctx.restore();
  }
}

// --- Screens ---
function drawWelcomeScreen() {
  clearCanvas();
  // Background
  const bg = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
  bg.addColorStop(0, '#f8f9ff');
  bg.addColorStop(1, '#e8ecff');
  drawRoundRect(0, 0, canvas.width, canvas.height, 20, null, null);
  ctx.fillStyle = bg;
  ctx.fillRect(0, 0, canvas.width, canvas.height);

  // Decorative card shapes
  ctx.save();
  ctx.globalAlpha = 0.08;
  for (let i = 0; i < 6; i++) {
    const x = 50 + i * 90;
    const y = 280 + Math.sin(i * 1.2) * 30;
    drawRoundRect(x, y, 70, 90, 10, '#667eea', null);
  }
  ctx.restore();

  // Title
  ctx.font = 'bold 36px system-ui, sans-serif';
  ctx.fillStyle = '#333';
  ctx.textAlign = 'center';
  ctx.fillText('Constellation Challenge', canvas.width / 2, 120);

  // Subtitle
  ctx.font = '18px system-ui, sans-serif';
  ctx.fillStyle = '#777';
  ctx.fillText('10 random star maps to identify', canvas.width / 2, 160);
  ctx.fillText('Name the constellation to earn points!', canvas.width / 2, 185);

  // Card icon
  ctx.save();
  ctx.translate(canvas.width / 2, 240);
  ctx.rotate(-0.15);
  drawRoundRect(-40, -30, 80, 60, 8, '#667eea', null);
  ctx.rotate(0.3);
  drawRoundRect(-40, -30, 80, 60, 8, '#f093fb', null);
  ctx.font = 'bold 24px system-ui, sans-serif';
  ctx.fillStyle = '#fff';
  ctx.textAlign = 'center';
  ctx.fillText('?', 0, 6);
  ctx.restore();

  ctx.font = '15px system-ui, sans-serif';
  ctx.fillStyle = '#999';
  ctx.textAlign = 'center';
  ctx.fillText(`${allCards.length} cards loaded`, canvas.width / 2, 380);
}

function drawQuestionCard(card) {
  clearCanvas();

  // Canvas background
  const bg = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
  bg.addColorStop(0, '#f0f0ff');
  bg.addColorStop(1, '#fce4ff');
  ctx.fillStyle = bg;
  ctx.fillRect(0, 0, canvas.width, canvas.height);

  drawCardBackground();
  drawCardNumber();

  if (card.type === 'image' && loadedImage) {
    // Draw the image centered on the card
    const maxW = 440;
    const maxH = 280;
    let w = loadedImage.width;
    let h = loadedImage.height;
    const scale = Math.min(maxW / w, maxH / h, 1);
    w *= scale;
    h *= scale;
    const ix = (canvas.width - w) / 2;
    const iy = 50 + (300 - h) / 2;
    ctx.drawImage(loadedImage, ix, iy, w, h);
  } else {
    // Draw text question
    // Question mark icon
    ctx.font = 'bold 48px system-ui, sans-serif';
    ctx.fillStyle = '#e0e0ff';
    ctx.textAlign = 'center';
    ctx.fillText('?', canvas.width / 2, 90);

    drawWrappedText(
      card.input, canvas.width / 2, 180,
      440, 36, '24px system-ui, sans-serif', '#333'
    );
  }

  // "Type your answer below" hint
  ctx.font = '14px system-ui, sans-serif';
  ctx.fillStyle = '#aaa';
  ctx.textAlign = 'center';
  ctx.fillText('Type your answer below and press Submit', canvas.width / 2, 385);
}

function drawAnswerReveal(card, userAnswer, isCorrect) {
  clearCanvas();

  const bg = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
  if (isCorrect) {
    bg.addColorStop(0, '#e8ffe8');
    bg.addColorStop(1, '#c6ffd0');
  } else {
    bg.addColorStop(0, '#fff0f0');
    bg.addColorStop(1, '#ffe0e0');
  }
  ctx.fillStyle = bg;
  ctx.fillRect(0, 0, canvas.width, canvas.height);

  drawCardBackground();
  drawCardNumber();

  // Result badge
  const badgeY = 60;
  const badgeText = isCorrect ? 'Correct!' : 'Not quite!';
  const badgeColor = isCorrect ? '#22c55e' : '#ef4444';
  const badgeBg = isCorrect ? '#dcfce7' : '#fee2e2';

  ctx.save();
  const badgeW = 180;
  const badgeH = 40;
  const badgeX = (canvas.width - badgeW) / 2;
  drawRoundRect(badgeX, badgeY, badgeW, badgeH, badgeH / 2, badgeBg, badgeColor);
  ctx.font = 'bold 20px system-ui, sans-serif';
  ctx.fillStyle = badgeColor;
  ctx.textAlign = 'center';
  ctx.fillText(badgeText, canvas.width / 2, badgeY + 27);
  ctx.restore();

  // Your answer
  ctx.font = '16px system-ui, sans-serif';
  ctx.fillStyle = '#888';
  ctx.textAlign = 'center';
  ctx.fillText('Your answer:', canvas.width / 2, 140);

  ctx.font = 'bold 22px system-ui, sans-serif';
  ctx.fillStyle = isCorrect ? '#16a34a' : '#dc2626';
  ctx.fillText(userAnswer || '(no answer)', canvas.width / 2, 170);

  // Correct answer
  ctx.font = '16px system-ui, sans-serif';
  ctx.fillStyle = '#888';
  ctx.fillText('Correct answer:', canvas.width / 2, 220);

  ctx.font = 'bold 28px system-ui, sans-serif';
  ctx.fillStyle = '#333';
  ctx.fillText(card.answer, canvas.width / 2, 258);

  // Divider
  ctx.beginPath();
  ctx.moveTo(150, 285);
  ctx.lineTo(450, 285);
  ctx.strokeStyle = '#e0e0e0';
  ctx.lineWidth = 1;
  ctx.stroke();

  // Running score
  ctx.font = '18px system-ui, sans-serif';
  ctx.fillStyle = '#666';
  ctx.textAlign = 'center';
  ctx.fillText(`Score so far: ${score} out of ${answered}`, canvas.width / 2, 320);

  // Progress dots
  const dotStartX = canvas.width / 2 - (gameCards.length * 18) / 2;
  for (let i = 0; i < gameCards.length; i++) {
    ctx.beginPath();
    ctx.arc(dotStartX + i * 18, 355, 6, 0, Math.PI * 2);
    if (i < answered) {
      ctx.fillStyle = i < answered && gameCards[i]._correct ? '#22c55e' : '#ef4444';
      if (i === answered - 1) {
        ctx.fillStyle = isCorrect ? '#22c55e' : '#ef4444';
      }
    } else {
      ctx.fillStyle = '#e0e0e0';
    }
    ctx.fill();
  }

  // Particles for correct
  if (isCorrect) {
    spawnParticles(canvas.width / 2, badgeY + 20);
  }
}

function drawFinalScreen() {
  clearCanvas();

  const bg = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
  bg.addColorStop(0, '#fdf4ff');
  bg.addColorStop(1, '#f0e6ff');
  ctx.fillStyle = bg;
  ctx.fillRect(0, 0, canvas.width, canvas.height);

  // Trophy / celebration
  ctx.font = '64px system-ui, sans-serif';
  ctx.textAlign = 'center';
  const emoji = score >= 8 ? '\u{1F3C6}' : score >= 5 ? '\u{1F31F}' : '\u{1F4AA}';
  ctx.fillText(emoji, canvas.width / 2, 90);

  ctx.font = 'bold 32px system-ui, sans-serif';
  ctx.fillStyle = '#333';
  ctx.fillText('Game Over!', canvas.width / 2, 140);

  // Score circle
  const cx = canvas.width / 2;
  const cy = 230;
  const r = 60;

  // Background circle
  ctx.beginPath();
  ctx.arc(cx, cy, r, 0, Math.PI * 2);
  ctx.fillStyle = '#f0f0ff';
  ctx.fill();
  ctx.strokeStyle = '#667eea';
  ctx.lineWidth = 4;
  ctx.stroke();

  // Score arc
  const pct = score / gameCards.length;
  ctx.beginPath();
  ctx.arc(cx, cy, r, -Math.PI / 2, -Math.PI / 2 + Math.PI * 2 * pct);
  const scoreGrad = ctx.createLinearGradient(cx - r, cy, cx + r, cy);
  scoreGrad.addColorStop(0, '#43e97b');
  scoreGrad.addColorStop(1, '#38f9d7');
  ctx.strokeStyle = scoreGrad;
  ctx.lineWidth = 6;
  ctx.stroke();

  // Score text
  ctx.font = 'bold 36px system-ui, sans-serif';
  ctx.fillStyle = '#333';
  ctx.textAlign = 'center';
  ctx.fillText(`${score}`, cx, cy + 8);
  ctx.font = '16px system-ui, sans-serif';
  ctx.fillStyle = '#888';
  ctx.fillText(`out of ${gameCards.length}`, cx, cy + 32);

  // Message
  let msg = '';
  if (pct === 1) msg = 'Perfect score! Amazing!';
  else if (pct >= 0.8) msg = 'Great job! Almost perfect!';
  else if (pct >= 0.5) msg = 'Good effort! Keep practicing!';
  else msg = 'Keep learning, you\'ll get there!';

  ctx.font = '20px system-ui, sans-serif';
  ctx.fillStyle = '#555';
  ctx.fillText(msg, cx, 340);

  // Review dots
  const dotStartX = cx - (gameCards.length * 18) / 2;
  for (let i = 0; i < gameCards.length; i++) {
    ctx.beginPath();
    ctx.arc(dotStartX + i * 18, 380, 6, 0, Math.PI * 2);
    ctx.fillStyle = gameCards[i]._correct ? '#22c55e' : '#ef4444';
    ctx.fill();
  }

  // Spawn celebration particles
  if (particles.length === 0 && score > 0) {
    spawnParticles(cx - 80, 100);
    spawnParticles(cx + 80, 100);
    spawnParticles(cx, 140);
  }
}

// --- Animation loop ---
function animationLoop() {
  if (particles.length > 0) {
    updateParticles();
    // Redraw current screen then overlay particles
    if (state === 'answered') {
      const card = gameCards[currentIndex];
      drawAnswerReveal(card, card._userAnswer, card._correct);
      // Prevent re-spawning
    } else if (state === 'finished') {
      drawFinalScreen();
    }
    drawParticles();
  }
  animFrame = requestAnimationFrame(animationLoop);
}

// --- Game Flow ---
async function loadDatabase() {
  const resp = await fetch('flashcard-db.json');
  const data = await resp.json();
  allCards = data.cards;
}

function selectCards() {
  const shuffled = shuffle(allCards);
  gameCards = shuffled.slice(0, Math.min(10, shuffled.length));
  // Reset metadata
  gameCards.forEach(c => {
    c._correct = false;
    c._userAnswer = '';
  });
}

function loadCardImage(card) {
  return new Promise((resolve) => {
    if (card.type !== 'image') { loadedImage = null; resolve(); return; }
    const img = new Image();
    img.onload = () => { loadedImage = img; resolve(); };
    img.onerror = () => { loadedImage = null; resolve(); };
    img.src = card.input;
  });
}

async function showCard() {
  state = 'showing';
  const card = gameCards[currentIndex];
  await loadCardImage(card);
  drawQuestionCard(card);
  inputArea.style.display = 'block';
  nextBtn.style.display = 'none';
  guessInput.value = '';
  guessInput.focus();
  updateProgress();
}

function submitAnswer() {
  if (state !== 'showing') return;
  const card = gameCards[currentIndex];
  const userAnswer = guessInput.value;
  const isCorrect = normalize(userAnswer) === normalize(card.answer);

  card._userAnswer = userAnswer;
  card._correct = isCorrect;

  if (isCorrect) score++;
  answered++;

  state = 'answered';
  inputArea.style.display = 'none';
  particles = [];
  drawAnswerReveal(card, userAnswer, isCorrect);
  updateScoreDisplay();
  updateProgress();

  if (currentIndex < gameCards.length - 1) {
    nextBtn.style.display = 'inline-block';
  } else {
    // Last card - show finish button
    nextBtn.textContent = 'See Results';
    nextBtn.style.display = 'inline-block';
  }
}

function nextCard() {
  if (currentIndex < gameCards.length - 1) {
    currentIndex++;
    particles = [];
    showCard();
  } else {
    showFinalScreen();
  }
}

function showFinalScreen() {
  state = 'finished';
  inputArea.style.display = 'none';
  nextBtn.style.display = 'none';
  restartBtn.style.display = 'inline-block';
  particles = [];
  drawFinalScreen();
  updateProgress();
}

function updateScoreDisplay() {
  scoreDisplay.textContent = `Score: ${score} / ${answered}`;
}

function updateProgress() {
  const pct = (answered / gameCards.length) * 100;
  progressFill.style.width = pct + '%';
}

function resetGame() {
  currentIndex = 0;
  score = 0;
  answered = 0;
  particles = [];
  loadedImage = null;
  restartBtn.style.display = 'none';
  nextBtn.textContent = 'Next Card';
  updateScoreDisplay();
  selectCards();
  showCard();
}

// --- Event Listeners ---
submitBtn.addEventListener('click', submitAnswer);
guessInput.addEventListener('keydown', (e) => {
  if (e.key === 'Enter') submitAnswer();
});
nextBtn.addEventListener('click', nextCard);
startBtn.addEventListener('click', () => {
  startBtn.style.display = 'none';
  resetGame();
});
restartBtn.addEventListener('click', resetGame);

// --- Init ---
(async function init() {
  await loadDatabase();
  state = 'ready';
  drawWelcomeScreen();
  animationLoop();
})();
</script>
</body>
</html>
